<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Department - Exam Paper Archive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .folder {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .folder:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Firebase and App Dependencies -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, setDoc, getDoc, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        // Use environment variables provided by the Canvas environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-exam-archive';
        
        // --- FIREBASE INITIALIZATION ---
        let app, auth, db, papersCollection;
        let userId = null;
        let unsubscribeSnapshot = null; // To store the snapshot listener

        // --- DOM ELEMENTS ---
        const contentArea = document.getElementById('content-area');
        const breadcrumbsContainer = document.getElementById('breadcrumbs');
        const fileUploader = document.getElementById('file-uploader');
        const loadingIndicator = document.getElementById('loading-indicator');
        const currentYearSpan = document.getElementById('current-year');

        // --- APP STATE ---
        let state = {
            path: [], // e.g., ['BSc Physics', '2021-2025', '2023', '3']
            view: 'degrees', // degrees, batches, years, semesters, files
        };

        // Predefined folder structure
        const FOLDER_STRUCTURE = {
            'BSc Physics': {
                '2021-2025': { '2023': ['3', '4'], '2024': ['5', '6'] },
                '2022-2026': { '2024': ['1', '2'], '2025': ['3', '4'] }
            },
            'MSc Physics': {
                '2023-2025': { '2024': ['1', '2'], '2025': ['3', '4'] }
            },
            'PhD Physics': {
                '2023-2027': { '2024': ['1', '2'] }
            }
        };

        // --- RENDER FUNCTIONS ---

        function renderBreadcrumbs() {
            breadcrumbsContainer.innerHTML = `<a href="#" class="text-indigo-600 hover:underline" data-level="-1">Home</a>`;
            state.path.forEach((segment, index) => {
                breadcrumbsContainer.innerHTML += ` <span class="mx-2 text-gray-500">/</span> <a href="#" class="text-indigo-600 hover:underline" data-level="${index}">${segment}</a>`;
            });
        }

        function renderFolders(items, type) {
            contentArea.innerHTML = `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">` +
                items.map(item => `
                    <div class="folder bg-white p-4 rounded-lg shadow-md text-center cursor-pointer flex flex-col items-center justify-center" data-type="${type}" data-name="${item}">
                        <i class="fas fa-folder text-6xl text-yellow-400 mb-2"></i>
                        <span class="font-semibold text-gray-700">${item}</span>
                    </div>
                `).join('') + `</div>`;
        }

        function renderFiles(files) {
            let fileListHtml = files.length > 0 ? files.map(file => `
                <div class="bg-white p-3 rounded-md shadow-sm flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-file-pdf text-2xl text-red-500 mr-3"></i>
                        <span class="font-medium text-gray-800">${file.fileName}</span>
                    </div>
                    <span class="text-sm text-gray-500">${new Date(file.createdAt?.toDate()).toLocaleDateString()}</span>
                </div>
            `).join('') : `<p class="text-gray-500">No files uploaded yet.</p>`;

            contentArea.innerHTML = `
                <div class="space-y-3">
                    ${fileListHtml}
                </div>
                <div class="mt-6">
                    <button id="upload-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center">
                        <i class="fas fa-upload mr-2"></i> Upload File
                    </button>
                </div>
            `;
        }

        function render() {
            renderBreadcrumbs();
            loadingIndicator.classList.add('hidden');
            contentArea.classList.remove('hidden');

            if (unsubscribeSnapshot) {
                unsubscribeSnapshot(); // Detach old listener
                unsubscribeSnapshot = null;
            }

            switch (state.view) {
                case 'degrees':
                    renderFolders(Object.keys(FOLDER_STRUCTURE), 'degree');
                    break;
                case 'batches':
                    renderFolders(Object.keys(FOLDER_STRUCTURE[state.path[0]]), 'batch');
                    break;
                case 'years':
                    renderFolders(Object.keys(FOLDER_STRUCTURE[state.path[0]][state.path[1]]), 'year');
                    break;
                case 'semesters':
                    renderFolders(FOLDER_STRUCTURE[state.path[0]][state.path[1]][state.path[2]], 'semester');
                    break;
                case 'files':
                    listenForFiles();
                    break;
            }
        }
        
        // --- FIRESTORE LOGIC ---

        async function listenForFiles() {
            if (!db) return;
            contentArea.innerHTML = ''; // Clear content before showing loader
            loadingIndicator.classList.remove('hidden');

            const [degree, batch, year, semester] = state.path;
            const q = query(papersCollection,
                where("degree", "==", degree),
                where("batch", "==", batch),
                where("year", "==", year),
                where("semester", "==", semester)
            );

            unsubscribeSnapshot = onSnapshot(q, (querySnapshot) => {
                const files = [];
                querySnapshot.forEach((doc) => {
                    files.push({ id: doc.id, ...doc.data() });
                });
                // Sort by creation date, newest first
                files.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                loadingIndicator.classList.add('hidden');
                renderFiles(files);
            }, (error) => {
                console.error("Error fetching files: ", error);
                contentArea.innerHTML = `<p class="text-red-500">Error loading files. Please try again.</p>`;
                loadingIndicator.classList.add('hidden');
            });
        }
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !db) return;

            const [degree, batch, year, semester] = state.path;

            try {
                await addDoc(papersCollection, {
                    degree,
                    batch,
                    year,
                    semester,
                    fileName: file.name,
                    fileType: file.type,
                    fileSize: file.size,
                    uploaderId: userId,
                    createdAt: serverTimestamp()
                });
                // The onSnapshot listener will automatically update the UI
            } catch (error) {
                console.error("Error uploading file metadata: ", error);
                alert("Could not upload file data. Please try again.");
            }
            
            // Reset file input
            event.target.value = null;
        }

        // --- EVENT HANDLERS ---

        function handleNavigation(e) {
            const target = e.target.closest('[data-type], [data-level]');
            if (!target) return;

            e.preventDefault();

            if (target.dataset.level) { // Breadcrumb click
                const level = parseInt(target.dataset.level, 10);
                if (level === -1) { // Home
                     state.path = [];
                } else {
                    state.path = state.path.slice(0, level + 1);
                }
            } else { // Folder click
                state.path.push(target.dataset.name);
            }

            const depth = state.path.length;
            state.view = ['degrees', 'batches', 'years', 'semesters', 'files'][depth];
            render();
        }
        
        // --- INITIALIZATION ---
        
        async function main() {
            currentYearSpan.textContent = new Date().getFullYear();
            
            if (Object.keys(firebaseConfig).length === 0) {
                contentArea.innerHTML = `<p class="text-red-500 text-center">Firebase configuration is missing. The application cannot start.</p>`;
                return;
            }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            papersCollection = collection(db, `/artifacts/${appId}/public/data/papers`);

            contentArea.addEventListener('click', handleNavigation);
            breadcrumbsContainer.addEventListener('click', handleNavigation);
            fileUploader.addEventListener('change', handleFileUpload);

            // Use a delegated event listener for the upload button
            contentArea.addEventListener('click', e => {
                if (e.target.closest('#upload-button')) {
                    fileUploader.click();
                }
            });

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    render(); // Initial render
                }
            });
            
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                contentArea.innerHTML = `<p class="text-red-500 text-center">Could not authenticate with the server.</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>

    <!-- Header Section -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-3xl font-bold text-gray-900">Department of Physics</h1>
            <p class="text-lg text-gray-600">Exam Paper Archive</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">

        <!-- Breadcrumbs -->
        <div id="breadcrumbs" class="mb-6 text-sm font-medium">
            <!-- Breadcrumbs will be dynamically inserted here -->
        </div>

        <!-- Content Display Area -->
        <div id="loading-indicator" class="text-center py-10">
            <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
            <p class="mt-2 text-gray-600">Loading...</p>
        </div>
        <div id="content-area" class="hidden">
            <!-- Dynamic content (folders/files) will be inserted here -->
        </div>

        <!-- Hidden File Input for Uploads -->
        <input type="file" id="file-uploader" class="hidden" accept=".pdf,.doc,.docx,.txt,.pptx">

    </main>

    <!-- Footer Section -->
    <footer class="bg-white mt-12 py-6 border-t">
        <div class="container mx-auto px-6 text-center text-gray-600">
            <p>&copy; <span id="current-year"></span> Department of Physics. All Rights Reserved.</p>
        </div>
    </footer>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Department - Exam Paper Archive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .folder {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .folder:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Firebase and App Dependencies -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, setDoc, getDoc, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        // Use environment variables provided by the Canvas environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-exam-archive';
        
        // --- FIREBASE INITIALIZATION ---
        let app, auth, db, papersCollection;
        let userId = null;
        let unsubscribeSnapshot = null; // To store the snapshot listener

        // --- DOM ELEMENTS ---
        const contentArea = document.getElementById('content-area');
        const breadcrumbsContainer = document.getElementById('breadcrumbs');
        const fileUploader = document.getElementById('file-uploader');
        const loadingIndicator = document.getElementById('loading-indicator');
        const currentYearSpan = document.getElementById('current-year');

        // --- APP STATE ---
        let state = {
            path: [], // e.g., ['BSc Physics', '2021-2025', '2023', '3']
            view: 'degrees', // degrees, batches, years, semesters, files
        };

        // Predefined folder structure
        const FOLDER_STRUCTURE = {
            'BSc Physics': {
                '2021-2025': { '2023': ['3', '4'], '2024': ['5', '6'] },
                '2022-2026': { '2024': ['1', '2'], '2025': ['3', '4'] }
            },
            'MSc Physics': {
                '2023-2025': { '2024': ['1', '2'], '2025': ['3', '4'] }
            },
            'PhD Physics': {
                '2023-2027': { '2024': ['1', '2'] }
            }
        };

        // --- RENDER FUNCTIONS ---

        function renderBreadcrumbs() {
            breadcrumbsContainer.innerHTML = `<a href="#" class="text-indigo-600 hover:underline" data-level="-1">Home</a>`;
            state.path.forEach((segment, index) => {
                breadcrumbsContainer.innerHTML += ` <span class="mx-2 text-gray-500">/</span> <a href="#" class="text-indigo-600 hover:underline" data-level="${index}">${segment}</a>`;
            });
        }

        function renderFolders(items, type) {
            contentArea.innerHTML = `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">` +
                items.map(item => `
                    <div class="folder bg-white p-4 rounded-lg shadow-md text-center cursor-pointer flex flex-col items-center justify-center" data-type="${type}" data-name="${item}">
                        <i class="fas fa-folder text-6xl text-yellow-400 mb-2"></i>
                        <span class="font-semibold text-gray-700">${item}</span>
                    </div>
                `).join('') + `</div>`;
        }

        function renderFiles(files) {
            let fileListHtml = files.length > 0 ? files.map(file => `
                <div class="bg-white p-3 rounded-md shadow-sm flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-file-pdf text-2xl text-red-500 mr-3"></i>
                        <span class="font-medium text-gray-800">${file.fileName}</span>
                    </div>
                    <span class="text-sm text-gray-500">${new Date(file.createdAt?.toDate()).toLocaleDateString()}</span>
                </div>
            `).join('') : `<p class="text-gray-500">No files uploaded yet.</p>`;

            contentArea.innerHTML = `
                <div class="space-y-3">
                    ${fileListHtml}
                </div>
                <div class="mt-6">
                    <button id="upload-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center">
                        <i class="fas fa-upload mr-2"></i> Upload File
                    </button>
                </div>
            `;
        }

        function render() {
            renderBreadcrumbs();
            loadingIndicator.classList.add('hidden');
            contentArea.classList.remove('hidden');

            if (unsubscribeSnapshot) {
                unsubscribeSnapshot(); // Detach old listener
                unsubscribeSnapshot = null;
            }

            switch (state.view) {
                case 'degrees':
                    renderFolders(Object.keys(FOLDER_STRUCTURE), 'degree');
                    break;
                case 'batches':
                    renderFolders(Object.keys(FOLDER_STRUCTURE[state.path[0]]), 'batch');
                    break;
                case 'years':
                    renderFolders(Object.keys(FOLDER_STRUCTURE[state.path[0]][state.path[1]]), 'year');
                    break;
                case 'semesters':
                    renderFolders(FOLDER_STRUCTURE[state.path[0]][state.path[1]][state.path[2]], 'semester');
                    break;
                case 'files':
                    listenForFiles();
                    break;
            }
        }
        
        // --- FIRESTORE LOGIC ---

        async function listenForFiles() {
            if (!db) return;
            contentArea.innerHTML = ''; // Clear content before showing loader
            loadingIndicator.classList.remove('hidden');

            const [degree, batch, year, semester] = state.path;
            const q = query(papersCollection,
                where("degree", "==", degree),
                where("batch", "==", batch),
                where("year", "==", year),
                where("semester", "==", semester)
            );

            unsubscribeSnapshot = onSnapshot(q, (querySnapshot) => {
                const files = [];
                querySnapshot.forEach((doc) => {
                    files.push({ id: doc.id, ...doc.data() });
                });
                // Sort by creation date, newest first
                files.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                loadingIndicator.classList.add('hidden');
                renderFiles(files);
            }, (error) => {
                console.error("Error fetching files: ", error);
                contentArea.innerHTML = `<p class="text-red-500">Error loading files. Please try again.</p>`;
                loadingIndicator.classList.add('hidden');
            });
        }
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !db) return;

            const [degree, batch, year, semester] = state.path;

            try {
                await addDoc(papersCollection, {
                    degree,
                    batch,
                    year,
                    semester,
                    fileName: file.name,
                    fileType: file.type,
                    fileSize: file.size,
                    uploaderId: userId,
                    createdAt: serverTimestamp()
                });
                // The onSnapshot listener will automatically update the UI
            } catch (error) {
                console.error("Error uploading file metadata: ", error);
                alert("Could not upload file data. Please try again.");
            }
            
            // Reset file input
            event.target.value = null;
        }

        // --- EVENT HANDLERS ---

        function handleNavigation(e) {
            const target = e.target.closest('[data-type], [data-level]');
            if (!target) return;

            e.preventDefault();

            if (target.dataset.level) { // Breadcrumb click
                const level = parseInt(target.dataset.level, 10);
                if (level === -1) { // Home
                     state.path = [];
                } else {
                    state.path = state.path.slice(0, level + 1);
                }
            } else { // Folder click
                state.path.push(target.dataset.name);
            }

            const depth = state.path.length;
            state.view = ['degrees', 'batches', 'years', 'semesters', 'files'][depth];
            render();
        }
        
        // --- INITIALIZATION ---
        
        async function main() {
            currentYearSpan.textContent = new Date().getFullYear();
            
            if (Object.keys(firebaseConfig).length === 0) {
                contentArea.innerHTML = `<p class="text-red-500 text-center">Firebase configuration is missing. The application cannot start.</p>`;
                return;
            }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            papersCollection = collection(db, `/artifacts/${appId}/public/data/papers`);

            contentArea.addEventListener('click', handleNavigation);
            breadcrumbsContainer.addEventListener('click', handleNavigation);
            fileUploader.addEventListener('change', handleFileUpload);

            // Use a delegated event listener for the upload button
            contentArea.addEventListener('click', e => {
                if (e.target.closest('#upload-button')) {
                    fileUploader.click();
                }
            });

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    render(); // Initial render
                }
            });
            
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                contentArea.innerHTML = `<p class="text-red-500 text-center">Could not authenticate with the server.</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>

    <!-- Header Section -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-3xl font-bold text-gray-900">Department of Physics</h1>
            <p class="text-lg text-gray-600">Exam Paper Archive</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">

        <!-- Breadcrumbs -->
        <div id="breadcrumbs" class="mb-6 text-sm font-medium">
            <!-- Breadcrumbs will be dynamically inserted here -->
        </div>

        <!-- Content Display Area -->
        <div id="loading-indicator" class="text-center py-10">
            <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
            <p class="mt-2 text-gray-600">Loading...</p>
        </div>
        <div id="content-area" class="hidden">
            <!-- Dynamic content (folders/files) will be inserted here -->
        </div>

        <!-- Hidden File Input for Uploads -->
        <input type="file" id="file-uploader" class="hidden" accept=".pdf,.doc,.docx,.txt,.pptx">

    </main>

    <!-- Footer Section -->
    <footer class="bg-white mt-12 py-6 border-t">
        <div class="container mx-auto px-6 text-center text-gray-600">
            <p>&copy; <span id="current-year"></span> Department of Physics. All Rights Reserved.</p>
        </div>
    </footer>

</body>
</html>
