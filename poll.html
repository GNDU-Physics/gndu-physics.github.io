<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poll System - GNDU Physics Club</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tahoma', sans-serif;
            background: url('https://specials-images.forbesimg.com/imageserve/6683c1640eb9ff99522c17f0/Misty-Mountains/960x0.jpg?fit=scale') no-repeat center center fixed;
            background-size: cover;
        }

        .window {
            background-color: #ECE9D8;
            border: 2px solid #000;
            border-top-color: #fff;
            border-left-color: #fff;
            box-shadow: 1px 1px 0 #000, inset 1px 1px 0 #fff;
            padding: 2px;
        }

        .title-bar {
            background: linear-gradient(to right, #0058D0, #0078F8);
            color: white;
            padding: 3px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            text-shadow: 1px 1px #000;
            cursor: default;
        }
        
        .title-bar-text {
            pointer-events: none;
        }

        .title-bar-controls {
            display: flex;
        }

        .title-bar-controls button {
            width: 20px;
            height: 20px;
            margin-left: 2px;
            border: 1px solid;
            border-color: #fff #666 #666 #fff;
            background-color: #C0C0C0;
            font-family: 'Marlett', 'Arial', sans-serif;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            box-shadow: 1px 1px 1px #000;
        }
        
        .window-body {
            padding: 1rem;
        }

        .xp-button {
            background-color: #ECE9D8;
            border: 1px solid #000;
            border-top-color: #fff;
            border-left-color: #fff;
            box-shadow: 1px 1px 0 #000, inset 1px 1px 0 #fff;
            padding: 8px 12px;
            font-weight: bold;
        }
        .xp-button:active {
            border-color: #666 #fff #fff #666;
            box-shadow: inset 1px 1px 0 #000;
        }
        .xp-button:disabled {
            color: #888;
            text-shadow: 1px 1px #fff;
        }

        .card {
            border: 2px outset #fff;
            cursor: pointer;
            transition: all 0.1s ease-in;
        }
        .card:active {
             border-style: inset;
        }
        .card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        
        .bar-container {
            border: 1px inset #fff;
            padding: 2px;
            background: #C0C0C0;
        }
        .bar {
            background-color: #0058D0;
            height: 20px;
            transition: width 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .xp-input {
            border: 2px inset #fff;
            border-color: #666 #fff #fff #666;
            box-shadow: inset 1px 1px 0 #000;
            background-color: white;
            padding: 4px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2">

    <div id="app-container" class="window w-full max-w-2xl">
        <div class="title-bar">
            <span class="title-bar-text">Polling System</span>
            <div class="title-bar-controls">
                <span>GNDU Physics Club</span>
            </div>
        </div>
        <div class="window-body">
            <!-- Login View -->
            <div id="login-view" class="text-center">
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Welcome to the Poll!</h1>
                <p id="login-prompt-text" class="text-gray-800 mb-6">Please select your role to continue.</p>
                <div id="role-selection" class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="admin-login-prompt" class="xp-button flex-1">I am an Admin</button>
                    <button id="audience-login" class="xp-button flex-1">I am an Audience Member</button>
                </div>
                <!-- Admin Password Section (Initially Hidden) -->
                <div id="admin-password-section" class="hidden mt-4">
                    <p class="font-bold mb-2">Enter Admin Password:</p>
                    <input type="password" id="admin-password-input" class="w-full xp-input">
                    <div class="flex gap-4 mt-4">
                        <button id="admin-login-submit" class="xp-button flex-1">Login</button>
                        <button id="admin-login-cancel" class="xp-button flex-1">Cancel</button>
                    </div>
                    <p id="password-error" class="text-red-600 font-bold mt-2 hidden">Incorrect Password!</p>
                </div>
            </div>

            <!-- Admin View -->
            <div id="admin-view" class="hidden">
                <h1 class="text-2xl font-bold text-gray-900 mb-4">Admin Dashboard</h1>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <button id="start-poll" class="flex-1 xp-button bg-green-500 text-white disabled:bg-gray-400">
                        Start 15-Second Poll
                    </button>
                    <button id="reset-poll" class="flex-1 xp-button bg-red-600 text-white">
                        Reset Poll
                    </button>
                </div>
                <div id="admin-status" class="text-center mt-4 font-bold h-6"></div>
                <div id="admin-results-container" class="mt-6">
                    <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Live Poll Results</h2>
                    <div id="admin-results"></div>
                    <p id="admin-no-poll" class="text-center text-gray-600 py-6">No active poll. Click "Start Poll" to begin.</p>
                </div>
                <div id="total-votes-container" class="text-center mt-4 font-bold text-lg hidden">
                    <!-- Total votes will be displayed here -->
                </div>
            </div>

            <!-- Audience View -->
            <div id="audience-view" class="hidden">
                <h1 class="text-2xl font-bold text-gray-900 mb-4">Cast Your Vote</h1>
                <div id="timer-container" class="text-center mb-4 hidden">
                    <p class="text-lg font-bold text-red-700">Time Remaining: <span id="timer" class="text-xl">15</span>s</p>
                </div>
                
                <div id="audience-poll-container">
                    <div id="cards-container" class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4 mb-4">
                        <div id="card1" data-card="card1" class="card bg-blue-500 text-white p-6 text-center disabled"><h3 class="text-xl font-bold">1</h3></div>
                        <div id="card2" data-card="card2" class="card bg-purple-500 text-white p-6 text-center disabled"><h3 class="text-xl font-bold">2</h3></div>
                        <div id="card3" data-card="card3" class="card bg-teal-500 text-white p-6 text-center disabled"><h3 class="text-xl font-bold">3</h3></div>
                    </div>
                    <p id="vote-message" class="text-center text-gray-800 font-semibold py-6">Waiting for the admin to start the poll...</p>
                </div>

                <div id="audience-results-container" class="hidden">
                    <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Poll Results</h2>
                    <div id="audience-results"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, serverTimestamp, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDRyBGcSgLaH6jbqgDY9Yn8t1Rw9o-jWJw",
            authDomain: "nspd25-996bf.firebaseapp.com",
            databaseURL: "https://nspd25-996bf-default-rtdb.firebaseio.com",
            projectId: "nspd25-996bf",
            storageBucket: "nspd25-996bf.appspot.com",
            messagingSenderId: "678844470957",
            appId: "1:678844470957:web:04a29772c95ebf67c21824",
            measurementId: "G-GRCBT2KMKH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Elements
        const loginView = document.getElementById('login-view');
        const adminView = document.getElementById('admin-view');
        const audienceView = document.getElementById('audience-view');
        const audienceLoginBtn = document.getElementById('audience-login');
        const startPollBtn = document.getElementById('start-poll');
        const resetPollBtn = document.getElementById('reset-poll');
        const cards = document.querySelectorAll('.card');
        const timerEl = document.getElementById('timer');
        const timerContainer = document.getElementById('timer-container');
        const voteMessage = document.getElementById('vote-message');
        const audienceResultsContainer = document.getElementById('audience-results-container');
        const audiencePollContainer = document.getElementById('audience-poll-container');
        const adminResultsContainer = document.getElementById('admin-results-container');
        const adminNoPollMsg = document.getElementById('admin-no-poll');
        const adminStatus = document.getElementById('admin-status');
        const totalVotesContainer = document.getElementById('total-votes-container');
        
        // Admin Login UI
        const roleSelection = document.getElementById('role-selection');
        const adminPasswordSection = document.getElementById('admin-password-section');
        const adminLoginPromptBtn = document.getElementById('admin-login-prompt');
        const adminLoginSubmitBtn = document.getElementById('admin-login-submit');
        const adminLoginCancelBtn = document.getElementById('admin-login-cancel');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const passwordError = document.getElementById('password-error');
        const loginPromptText = document.getElementById('login-prompt-text');

        let currentUser = null;
        let pollUnsubscribe = null;
        let pollStateInterval = null;
        let currentPollData = null;
        let isAdminResultsRevealed = false; 
        let lastTickTime = 0;

        // Sound Synthesis
        const synth = new Tone.Synth().toDestination();

        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
        });

        const signIn = async (role) => {
            try {
                if (role === 'audience' && Tone.context.state !== 'running') {
                    await Tone.start();
                    console.log('Audio context started for audience');
                }
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
                loginView.classList.add('hidden');
                if (role === 'admin') {
                    adminView.classList.remove('hidden');
                } else {
                    audienceView.classList.remove('hidden');
                }
                listenToPoll();
            } catch (error) {
                console.error("Authentication failed:", error);
                const statusEl = role === 'admin' ? adminStatus : voteMessage;
                statusEl.textContent = "Error: Could not sign in.";
            }
        };

        // --- Login Flow Listeners ---
        audienceLoginBtn.addEventListener('click', () => signIn('audience'));
        
        adminLoginPromptBtn.addEventListener('click', () => {
            roleSelection.classList.add('hidden');
            loginPromptText.classList.add('hidden');
            adminPasswordSection.classList.remove('hidden');
            adminPasswordInput.focus();
        });

        adminLoginCancelBtn.addEventListener('click', () => {
            roleSelection.classList.remove('hidden');
            loginPromptText.classList.remove('hidden');
            adminPasswordSection.classList.add('hidden');
            adminPasswordInput.value = '';
            passwordError.classList.add('hidden');
        });

        adminLoginSubmitBtn.addEventListener('click', () => {
            const password = adminPasswordInput.value;
            if (password === 'terabaap') {
                signIn('admin');
            } else {
                passwordError.classList.remove('hidden');
                adminPasswordInput.value = '';
                adminPasswordInput.focus();
            }
        });
        
        adminPasswordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                adminLoginSubmitBtn.click();
            }
        });


        // --- Firebase Firestore Logic ---
        const pollDocRef = doc(db, "polls", "live_poll");

        startPollBtn.addEventListener('click', async () => {
            startPollBtn.disabled = true;
            isAdminResultsRevealed = false;
            try {
                await setDoc(pollDocRef, {
                    startTime: serverTimestamp(),
                    votes: { card1: 0, card2: 0, card3: 0 },
                    voters: []
                });
            } catch (error) {
                console.error("Error starting poll:", error);
                adminStatus.textContent = "Error: Failed to start poll.";
                startPollBtn.disabled = false;
            }
        });

        resetPollBtn.addEventListener('click', async () => {
            resetPollBtn.disabled = true;
            try {
                await deleteDoc(pollDocRef);
                adminStatus.textContent = "Poll has been reset.";
            } catch (error) {
                console.error("Error resetting poll:", error);
                adminStatus.textContent = "Error: Could not reset poll.";
            } finally {
                resetPollBtn.disabled = false;
            }
        });

        cards.forEach(card => {
            card.addEventListener('click', async () => {
                if (card.classList.contains('disabled') || !currentUser || !currentPollData) return;
                
                const cardId = card.dataset.card;
                
                try {
                    const pollSnap = await getDoc(pollDocRef);
                    if (!pollSnap.exists()) throw new Error("Poll does not exist.");

                    const serverPollData = pollSnap.data();
                    const endTime = serverPollData.startTime.toDate().getTime() + 15000;

                    if (Date.now() > endTime) {
                         throw new Error("Poll has already ended.");
                    }
                    if (serverPollData.voters.includes(currentUser.uid)) {
                        throw new Error("User has already voted.");
                    }

                    await updateDoc(pollDocRef, {
                        [`votes.${cardId}`]: (serverPollData.votes[cardId] || 0) + 1,
                        voters: arrayUnion(currentUser.uid)
                    });
                    
                } catch (error) {
                    console.error("Error casting vote:", error);
                    voteMessage.textContent = error.message;
                    voteMessage.classList.remove('hidden');
                    disableVotingCards();
                }
            });
        });

        // --- Real-time Listener & State Management ---
        function listenToPoll() {
            if (pollUnsubscribe) pollUnsubscribe();

            pollUnsubscribe = onSnapshot(pollDocRef, (doc) => {
                if (doc.exists() && doc.data().startTime) {
                    const hadData = !!currentPollData;
                    currentPollData = doc.data();
                    if (audienceView.offsetParent !== null) {
                        renderResults(currentPollData.votes, 'audience-results');
                    }
                    if (!hadData) {
                         renderResults(currentPollData.votes, 'admin-results');
                    }
                    if (!pollStateInterval) {
                        pollStateInterval = setInterval(managePollState, 250);
                    }
                } else {
                    resetUI();
                }
            }, (error) => {
                console.error("Error listening to poll:", error);
                resetUI();
            });
        }
        
        function resetUI() {
            clearInterval(pollStateInterval);
            pollStateInterval = null;
            currentPollData = null;
            isAdminResultsRevealed = false;
            
            if (adminView.offsetParent !== null) {
                adminNoPollMsg.classList.remove('hidden');
                adminResultsContainer.classList.add('hidden');
                totalVotesContainer.classList.add('hidden');
                startPollBtn.disabled = false;
                adminStatus.textContent = 'Ready to start a new poll.';
            }
            
            if (audienceView.offsetParent !== null) {
                audiencePollContainer.classList.remove('hidden');
                audienceResultsContainer.classList.add('hidden');
                timerContainer.classList.add('hidden');
                disableVotingCards();
                voteMessage.textContent = "Waiting for the admin to start the poll...";
            }
        }

        function managePollState() {
            if (!currentPollData || !currentPollData.startTime) {
                resetUI();
                return;
            }

            const now = Date.now();
            const startTime = currentPollData.startTime.toDate().getTime();
            const voteEndTime = startTime + 15000;
            const resultsVisibleTime = voteEndTime + 5000;

            const hasVoted = currentUser && currentPollData.voters.includes(currentUser.uid);
            const isAudience = audienceView.offsetParent !== null;
            const isAdmin = adminView.offsetParent !== null;

            if (now >= startTime && now < voteEndTime) {
                const timeLeft = Math.max(0, Math.ceil((voteEndTime - now) / 1000));
                
                if (isAdmin) {
                    adminStatus.textContent = `Poll is LIVE! Ending in ${timeLeft}s.`;
                    startPollBtn.disabled = true;
                    adminResultsContainer.classList.add('hidden');
                    totalVotesContainer.classList.add('hidden');
                    adminNoPollMsg.classList.remove('hidden');
                }
                if (isAudience) {
                    timerContainer.classList.remove('hidden');
                    timerEl.textContent = timeLeft;
                    if (timeLeft <= 5 && timeLeft > 0 && timeLeft !== lastTickTime) {
                        synth.triggerAttackRelease("C5", "8n");
                        lastTickTime = timeLeft;
                    } else if (timeLeft > 5) {
                        lastTickTime = 0; // Reset tick time
                    }

                    audienceResultsContainer.classList.add('hidden');
                    audiencePollContainer.classList.remove('hidden');

                    if (hasVoted) {
                        disableVotingCards();
                        voteMessage.textContent = "Thank you for voting!";
                    } else {
                        enableVotingCards();
                        voteMessage.textContent = "The poll is live! Please vote now.";
                    }
                }
            }
            else if (now >= voteEndTime && now < resultsVisibleTime) {
                 if (isAdmin) {
                    adminStatus.textContent = 'Voting has ended. Calculating results...';
                    adminResultsContainer.classList.add('hidden');
                 }
                 if (isAudience) {
                    timerContainer.classList.add('hidden');
                    disableVotingCards();
                    voteMessage.textContent = "Time's up! Calculating results...";
                 }
            }
            else if (now >= resultsVisibleTime) {
                if (isAdmin) {
                    adminStatus.textContent = 'Poll has ended. Final results are shown.';
                    startPollBtn.disabled = false; 
                    if (!isAdminResultsRevealed) {
                        isAdminResultsRevealed = true;
                        revealAdminResults(currentPollData.votes);
                    }
                }
                if (isAudience) {
                    audiencePollContainer.classList.add('hidden');
                    audienceResultsContainer.classList.remove('hidden');
                }
                
                clearInterval(pollStateInterval);
                pollStateInterval = null;
            }
        }

        function enableVotingCards() {
            cards.forEach(card => card.classList.remove('disabled'));
        }

        function disableVotingCards() {
            cards.forEach(card => card.classList.add('disabled'));
        }
        
        function revealAdminResults(votes) {
            adminResultsContainer.classList.remove('hidden');
            adminNoPollMsg.classList.add('hidden');
            totalVotesContainer.classList.add('hidden');
            
            // Directly render the final results
            renderResults(votes, 'admin-results', false, true); 

            const totalVotes = Object.values(votes).reduce((sum, count) => sum + count, 0);
            totalVotesContainer.textContent = `Total Votes: ${totalVotes}`;
            totalVotesContainer.classList.remove('hidden');
        }

        function renderResults(votes, containerId, initialRender = false, animateFinal = false) {
            const container = document.getElementById(containerId);
            if (!container || !votes) return;

            const totalVotes = Object.values(votes).reduce((sum, count) => sum + count, 0);
            const resultsHtml = Object.keys(votes).sort().map(cardId => { // Sort keys to ensure order
                const count = votes[cardId];
                const percentage = totalVotes === 0 ? 0 : ((count / totalVotes) * 100);
                const displayPercentage = initialRender ? '0.0' : percentage.toFixed(1);
                const barWidth = initialRender ? 0 : percentage;
                const cardName = cardId.replace('card', ''); // Changed to show only the number
                
                return `
                    <div class="mb-2">
                        <div class="flex justify-between items-center mb-1 text-sm">
                            <span class="font-bold">Card ${cardName}</span>
                            <span class="vote-count">${count} votes (${displayPercentage}%)</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar" style="width: ${barWidth}%;"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = resultsHtml;

            if (animateFinal) {
                const bars = container.querySelectorAll('.bar');
                const voteCounts = container.querySelectorAll('.vote-count');
                const sortedKeys = Object.keys(votes).sort();

                sortedKeys.forEach((cardId, index) => {
                    const bar = bars[index];
                    const countEl = voteCounts[index];
                    if (bar && countEl) {
                        const count = votes[cardId];
                        const percentage = totalVotes === 0 ? 0 : ((count / totalVotes) * 100);
                        
                        setTimeout(() => {
                            bar.style.width = `${percentage}%`;
                            countEl.textContent = `${count} votes (${percentage.toFixed(1)}%)`;
                        }, 100); 
                    }
                });
            }
        }
    </script>
</body>
</html>
