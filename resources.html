<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Department - Exam Paper Archive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .folder {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .folder:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Firebase and App Dependencies -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        // Use the specific Firebase config provided by the user.
        const firebaseConfig = {
            apiKey: "AIzaSyBZjTMc2pcynlhKAqoWK20JZGcmlNeisxE",
            authDomain: "gndu-phys.firebaseapp.com",
            databaseURL: "https://gndu-phys-default-rtdb.firebaseio.com",
            projectId: "gndu-phys",
            storageBucket: "gndu-phys.appspot.com",
            messagingSenderId: "527351049402",
            appId: "1:527351049402:web:dd63e6c0ab229f165a2683",
            measurementId: "G-WQGP6DHMSL"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gndu-phys'; // Use projectId as fallback
        
        // --- FIREBASE INITIALIZATION ---
        let app, auth, db, papersCollection;
        let userId = null;
        let unsubscribeSnapshot = null; // To store the snapshot listener

        // --- DOM ELEMENTS ---
        const contentArea = document.getElementById('content-area');
        const breadcrumbsContainer = document.getElementById('breadcrumbs');
        const fileUploader = document.getElementById('file-uploader');
        const loadingIndicator = document.getElementById('loading-indicator');
        const currentYearSpan = document.getElementById('current-year');
        const notificationModal = document.getElementById('notification-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalIcon = document.getElementById('modal-icon');
        const modalCloseButton = document.getElementById('modal-close-button');

        // --- APP STATE ---
        let state = {
            path: [], // e.g., ['BSc Physics', '2021-2025', '2023', '3']
            view: 'degrees', // degrees, batches, years, semesters, files
        };

        // Predefined folder structure
        const FOLDER_STRUCTURE = {
            'BSc Physics': {
                '2021-2025': { '2023': ['3', '4'], '2024': ['5', '6'] },
                '2022-2026': { '2024': ['1', '2'], '2025': ['3', '4'] }
            },
            'MSc Physics': {
                '2023-2025': { '2024': ['1', '2'], '2025': ['3', '4'] }
            },
            'PhD Physics': {
                '2023-2027': { '2024': ['1', '2'] }
            }
        };

        // --- RENDER FUNCTIONS ---

        function renderBreadcrumbs() {
            breadcrumbsContainer.innerHTML = `<a href="#" class="text-indigo-600 hover:underline" data-level="-1">Home</a>`;
            state.path.forEach((segment, index) => {
                breadcrumbsContainer.innerHTML += ` <span class="mx-2 text-gray-500">/</span> <a href="#" class="text-indigo-600 hover:underline" data-level="${index}">${segment}</a>`;
            });
        }

        function renderFolders(items, type) {
            contentArea.innerHTML = `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">` +
                items.map(item => `
                    <div class="folder bg-white p-4 rounded-lg shadow-md text-center cursor-pointer flex flex-col items-center justify-center" data-type="${type}" data-name="${item}">
                        <i class="fas fa-folder text-6xl text-yellow-400 mb-2"></i>
                        <span class="font-semibold text-gray-700">${item}</span>
                    </div>
                `).join('') + `</div>`;
        }

        function renderFiles(files) {
            let fileListHtml = files.length > 0 ? files.map(file => {
                const fileIcon = getFileIcon(file.fileName);
                return `
                    <div class="bg-white p-3 rounded-md shadow-sm flex items-center justify-between">
                        <div class="flex items-center min-w-0">
                            <i class="fas ${fileIcon.icon} text-2xl ${fileIcon.color} mr-3"></i>
                            <span class="font-medium text-gray-800 truncate" title="${file.fileName}">${file.fileName}</span>
                        </div>
                        <span class="text-sm text-gray-500 flex-shrink-0 ml-2">${new Date(file.createdAt?.toDate()).toLocaleDateString()}</span>
                    </div>`;
            }).join('') : `<p class="text-gray-500">No files uploaded yet. Be the first to contribute!</p>`;

            contentArea.innerHTML = `
                <div class="space-y-3">
                    ${fileListHtml}
                </div>
                <div class="mt-6">
                    <button id="upload-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center">
                        <i class="fas fa-upload mr-2"></i> Upload File
                    </button>
                </div>
            `;
        }

        function render() {
            renderBreadcrumbs();
            loadingIndicator.classList.add('hidden');
            contentArea.classList.remove('hidden');

            if (unsubscribeSnapshot) {
                unsubscribeSnapshot(); // Detach old listener
                unsubscribeSnapshot = null;
            }

            switch (state.view) {
                case 'degrees':
                    renderFolders(Object.keys(FOLDER_STRUCTURE), 'degree');
                    break;
                case 'batches':
                    renderFolders(Object.keys(FOLDER_STRUCTURE[state.path[0]]), 'batch');
                    break;
                case 'years':
                    renderFolders(Object.keys(FOLDER_STRUCTURE[state.path[0]][state.path[1]]), 'year');
                    break;
                case 'semesters':
                    renderFolders(FOLDER_STRUCTURE[state.path[0]][state.path[1]][state.path[2]], 'semester');
                    break;
                case 'files':
                    listenForFiles();
                    break;
            }
        }
        
        // --- FIRESTORE LOGIC ---

        function listenForFiles() {
            if (!db) return;
            contentArea.innerHTML = ''; // Clear content before showing loader
            loadingIndicator.classList.remove('hidden');

            const [degree, batch, year, semester] = state.path;
            const q = query(papersCollection,
                where("degree", "==", degree),
                where("batch", "==", batch),
                where("year", "==", year),
                where("semester", "==", semester)
            );

            unsubscribeSnapshot = onSnapshot(q, (querySnapshot) => {
                const files = [];
                querySnapshot.forEach((doc) => {
                    files.push({ id: doc.id, ...doc.data() });
                });
                files.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                loadingIndicator.classList.add('hidden');
                renderFiles(files);
            }, (error) => {
                console.error("Error fetching files: ", error);
                contentArea.innerHTML = `<p class="text-red-500">Error loading files. Please try again.</p>`;
                loadingIndicator.classList.add('hidden');
            });
        }
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !db) return;

            const [degree, batch, year, semester] = state.path;

            try {
                await addDoc(papersCollection, {
                    degree,
                    batch,
                    year,
                    semester,
                    fileName: file.name,
                    fileType: file.type,
                    fileSize: file.size,
                    uploaderId: userId,
                    createdAt: serverTimestamp()
                });
                showNotification('Success', `File "${file.name}" metadata uploaded.`);
            } catch (error) {
                console.error("Error uploading file metadata: ", error);
                showNotification('Upload Failed', 'Could not save file data. Please check the console for errors.', true);
            }
            
            event.target.value = null; // Reset file input
        }

        // --- UTILITY FUNCTIONS ---
        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            switch (extension) {
                case 'pdf': return { icon: 'fa-file-pdf', color: 'text-red-500' };
                case 'doc':
                case 'docx': return { icon: 'fa-file-word', color: 'text-blue-500' };
                case 'ppt':
                case 'pptx': return { icon: 'fa-file-powerpoint', color: 'text-orange-500' };
                case 'txt': return { icon: 'fa-file-alt', color: 'text-gray-500' };
                default: return { icon: 'fa-file', color: 'text-gray-500' };
            }
        }

        function showNotification(title, message, isError = false) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            if (isError) {
                modalIcon.innerHTML = `<i class="fas fa-times text-2xl text-red-600"></i>`;
                modalIcon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100';
            } else {
                modalIcon.innerHTML = `<i class="fas fa-check text-2xl text-green-600"></i>`;
                modalIcon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100';
            }
            notificationModal.classList.remove('hidden');
        }

        // --- EVENT HANDLERS ---
        function handleNavigation(e) {
            const target = e.target.closest('[data-type], [data-level]');
            if (!target) return;
            e.preventDefault();

            if (target.dataset.level) {
                const level = parseInt(target.dataset.level, 10);
                state.path = (level === -1) ? [] : state.path.slice(0, level + 1);
            } else {
                state.path.push(target.dataset.name);
            }

            const depth = state.path.length;
            state.view = ['degrees', 'batches', 'years', 'semesters', 'files'][depth];
            render();
        }
        
        // --- INITIALIZATION ---
        async function main() {
            currentYearSpan.textContent = new Date().getFullYear();
            
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug'); // Enable detailed Firestore logging for debugging
            papersCollection = collection(db, `/artifacts/${appId}/public/data/papers`);

            contentArea.addEventListener('click', handleNavigation);
            breadcrumbsContainer.addEventListener('click', handleNavigation);
            fileUploader.addEventListener('change', handleFileUpload);
            modalCloseButton.addEventListener('click', () => notificationModal.classList.add('hidden'));

            contentArea.addEventListener('click', e => {
                if (e.target.closest('#upload-button')) fileUploader.click();
            });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    if (state.path.length === 0) { // Only render on initial auth
                       render();
                    }
                }
            });
            
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                loadingIndicator.classList.add('hidden');
                contentArea.innerHTML = `<p class="text-red-500 text-center">Could not authenticate with the server. Please check your connection and Firebase setup.</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>

    <!-- Header Section -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-3xl font-bold text-gray-900">Department of Physics</h1>
            <p class="text-lg text-gray-600">Exam Paper Archive</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <div id="breadcrumbs" class="mb-6 text-sm font-medium"></div>
        <div id="loading-indicator" class="text-center py-10">
            <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
            <p class="mt-2 text-gray-600">Connecting to Archive...</p>
        </div>
        <div id="content-area" class="hidden"></div>
        <input type="file" id="file-uploader" class="hidden" accept=".pdf,.doc,.docx,.txt,.pptx,.ppt">
    </main>

    <!-- Footer Section -->
    <footer class="bg-white mt-12 py-6 border-t">
        <div class="container mx-auto px-6 text-center text-gray-600">
            <p>&copy; <span id="current-year"></span> Department of Physics. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- Modal for Notifications -->
    <div id="notification-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full">
                     <!-- Icon (check/cross) will be set here by JS -->
                </div>
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modal-message" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-close-button" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
